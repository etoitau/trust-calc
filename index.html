<!DOCTYPE html>
<html lang="en">
<head>
    <title>Trust Calcuator</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <style>
        /* Set gray background color */
        .sidenav {
          background-color: #f1f1f1;
        }

        /* Set black background color, white text and some padding */
        nav, footer {
    /*      background-color: #555;*/
          color: white;
          padding: 15px;
        }

        #warning {
          color: red;
        }

        /* On small screens, set height to 'auto' for sidenav and grid */
        @media screen and (max-width: 767px) {
          .sidenav {
            height: auto;
            padding: 15px;
          }
          .row.content {height:auto;}
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand" href="#">Trust Calculator</a>
</nav>

<div class="container-fluid text-center">
    <div class="row content">
    <div class="col-sm-2 sidenav">
    </div>

    <div class="col-sm-8 text-left mt-3 mb-3">
        <p>Enter your estimates for the below parameters to get an estimate of how long the funds will last or how much will get donated and when.</p>
        <hr>
        <h3>Parameters</h3>
        <form>
            <div class="form-row">
                <div class="col-md-8">
                    <label for="principal">Current principal</label>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text">$</span>
                        </div>
                        <input id="principal" type="text" class="form-control" aria-label="dollars">
                        <div class="input-group-append">
                            <span class="input-group-text">.00</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="return">Return on principal</label>
                    <div class="input-group mb-3">
                        <input id="return" type="text" class="form-control" aria-label="percent">
                        <div class="input-group-append">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="col-md-8">
                    <label for="cost">Average round trip cost</label>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text">$</span>
                        </div>
                        <input id="cost" type="text" class="form-control" aria-label="dollars">
                        <div class="input-group-append">
                            <span class="input-group-text">.00</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="inflation">Inflation</label>
                    <div class="input-group mb-3">
                        <input id="inflation" type="text" class="form-control" aria-label="percent">
                        <div class="input-group-append">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <label for="beneficiaries">Beneficiaries (name, age; next name, age; ...)</label>
                <textarea class="form-control" id="beneficiaries" rows="3"></textarea>
            </div>

            <div class="form-row">
                <div class="col-md-6">
                    <label for="guests">Average guests per beneficiary per trip</label>
                    <div class="input-group mb-3">
                        <input id="guests" type="text" class="form-control" aria-label="number">
                        <div class="input-group-append">
                            <span class="input-group-text">guests</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="lifespan">Average life expectancy</label>
                    <div class="input-group mb-3">
                        <input id="lifespan" type="text" class="form-control" aria-label="age">
                        <div class="input-group-append">
                            <span class="input-group-text">years</span>
                        </div>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-block btn-dark" onclick="runCalc()">Run Calculator</button>
        </form>
        <div id="warning"></div>
        <div id="message"></div>
        <table id="table-data" class="table"></table>
    </div>


    <div class="col-sm-2 sidenav">
    </div>
    </div>
</div>

<footer class="footer footer-dark bg-dark container-fluid text-center">
  <p>kchatman@gmail.com</p>
</footer>

<script>
    let warningDiv;
    let messageDiv;
    let table;
    // Defaults
    const TRIPS_PER_YEAR = 3;
    const PRINCIPAL = 6000000;
    const RETURN = 1.0;
    const COST = 1000;
    const INFLATION = 3.0;
    const BENEFICIARIES = "Matilda, 4; Adam, 4; Lucy, 7; Arthur, 7; Clayton, 25; Lilly, 29; Clell, 33; Sarah, 33; Ariel, 37; Kyle, 37; Micaela, 39; Brian, 59; Laura, 62; Steve, 64; Doug, 66";
    const GUESTS = 1;
    const LIFESPAN = 78;
    // Inputs
    let principalField, returnField, costField, inflationField, beneficiaryField, guestsField, lifespanField;
    
    window.onload = () => {
        principalField = document.getElementById("principal");
        principalField.value = PRINCIPAL;
        returnField = document.getElementById("return");
        returnField.value = RETURN;
        costField = document.getElementById("cost");
        costField.value = COST;
        inflationField = document.getElementById("inflation");
        inflationField.value = INFLATION;
        beneficiaryField = document.getElementById("beneficiaries");
        beneficiaryField.value = BENEFICIARIES;
        guestsField = document.getElementById("guests");
        guestsField.value = GUESTS;
        lifespanField = document.getElementById("lifespan");
        lifespanField.value = LIFESPAN;
    }
    
    function runCalc() {
        getOutputDivs();
        clearOutput();
        let input = getInput();
        if (! input) {
            return;
        }
        let data = inputToData(input);
        while (true) {
            nextData = incData(data);
            if (nextData.principal <= 0) {
                messageDiv.append("Runs out of money with "
                    + nextData.years.reduce((a, b) => a + b, 0)
                    + " beneficiary-years remaining.");
                return;
            } else if (nextData.years.length < 1) {
                messageDiv.append(nextData.principal.toFixed(2) + " gets donated");
                return;
            }
            addRow(data);
            data = nextData;
        }
    }

    function addRow(data) {
        if (! table.firstChild) {
            initTable();
        }
        let row = table.insertRow();
        row.insertCell().appendChild(document.createTextNode(data.principal.toFixed(2)));
        row.insertCell().appendChild(document.createTextNode(data.cost.toFixed(2)));
        row.insertCell().appendChild(document.createTextNode(getTrips(data)));
        row.insertCell().appendChild(document.createTextNode(getInterest(data).toFixed(2)));
    }

    function initTable() {
        let labels = ["Principal", "Trip Cost", "Trips Taken", "Interest"];
        let thead = table.createTHead();
        let row = thead.insertRow();
        for (let label of labels) {
            let th = document.createElement("th");
            th.scope = "col";
            let text = document.createTextNode(label);
            th.appendChild(text);
            row.appendChild(th);
        }
    }

    function incData(data) {
        return {
            "principal" : data.principal - getCost(data) + getInterest(data),
            "rateReturn" : data.rateReturn,
            "cost" : data.cost * Math.exp(data.inflation / 100),
            "inflation" : data.inflation,
            "years" : decYears(data.years),
            "guests" : data.guests,
        };
    }
    
    function decYears(years) {
        let newYears = [];
        for (year of years) {
            if (year > 1) {
                newYears.push(year - 1);
            }
        }
        return newYears;
    }

    function getInterest(data) {
        let startPrinc = data.principal;
        let avgPrinc = startPrinc - getCost(data) / 2;
        return avgPrinc * (Math.exp(data.rateReturn / 100) - 1);
    }
    
    function getCost(data) {
        return data.cost * getTrips(data);
    }
    
    function getTrips(data) {
        return data.years.length * (1 + data.guests) * TRIPS_PER_YEAR;
    }
    
    function inputToData(input) {
        let years = [];
        for (let age of input.bene) {
            if (age < input.lifespan) {
                years.push(input.lifespan - age);
            }
        }
        input["years"] = years;
        return input;
    }

    function getInput() {
        let data = {};

        data["principal"] = getFloatFrom(document.getElementById("principal"));
        data["rateReturn"] = getFloatFrom(document.getElementById("return"));
        data["cost"] = getFloatFrom(document.getElementById("cost"));
        data["inflation"] = getFloatFrom(document.getElementById("inflation"));
        data["bene"] = getBeneFrom(document.getElementById("beneficiaries"));
        data["guests"] = getFloatFrom(document.getElementById("guests"));
        data["lifespan"] = getFloatFrom(document.getElementById("lifespan"));

        for (const [key, value] of Object.entries(data)) {
            if (! value && value != 0) {
                return null;
            }
        }
        return data;
    }

    function getBeneFrom(element) {
        let ages = [];
        let inString = element.value ? element.value : element.placeholder;
        let entries = inString.split(";")
        for (entry of entries) {
            let parts = entry.split(",");
            let age = parseInt(parts[parts.length - 1]);
            if (! age) {
                warningDiv.append = "Bad input for beneficiaries<br>";
                return null;
            }
            ages.push(age);
        }
        return ages;
    }

    // function getIntFrom(element) {
    //     if (! element.value) {
    //         return parseInt(element.placeholder, 10);
    //     }
    //     let parsed = parseInt(element.value, 10);
    //     if (isNaN(parsed)) {
    //         warningDiv.append = "Bad input for " + element.id + "<br>";
    //         return null;
    //     }
    //     return parsed;
    // }

    function getFloatFrom(element) {
        if (! element.value) {
            return parseFloat(element.placeholder, 10);
        }
        let parsed = parseFloat(element.value, 10);
        if (isNaN(parsed)) {
            warningDiv.append = "Bad input for " + element.id + "<br>";
            return null;
        }
        return parsed;
    }

    function getOutputDivs() {
        if (! warningDiv) {
            warningDiv = document.getElementById("warning");
        }
        if (! messageDiv) {
            messageDiv = document.getElementById("message");
        }
        if (! table) {
            table = document.getElementById("table-data");
        }
    }

    function clearOutput() {
        for (let element of [warningDiv, messageDiv, table]) {
            while (element.firstChild) {
                element.removeChild(element.firstChild);
            }
        }
    }

</script>

</body>
</html>
